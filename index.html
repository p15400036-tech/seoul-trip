<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦–çˆ¾æ—…è¨˜ 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #F2F2F7; /* è˜‹æœé¢¨æ ¼ç°åº• */
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --accent: #007AFF; /* iOS è— */
            --radius: 16px;
            
            /* é¡åˆ¥é¡è‰² */
            --color-food: #FF9500;   /* ç”¨é¤-æ©˜ */
            --color-spot: #34C759;   /* æ™¯é»-ç¶  */
            --color-shop: #AF52DE;   /* è³¼ç‰©-ç´« */
            --color-move: #007AFF;   /* äº¤é€š-è— */
            --color-other: #8E8E93;  /* å…¶ä»–-ç° */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); margin: 0; padding-bottom: 100px; overflow-x: hidden; }

        /* é ‚éƒ¨æ—¥æœŸæ»‘å‹•æ¢ */
        .date-scroller {
            display: flex;
            overflow-x: auto;
            padding: 15px 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 90;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            scrollbar-width: none; /* Firefox */
        }
        .date-scroller::-webkit-scrollbar { display: none; } /* Chrome */

        .date-pill {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            width: 60px;
            height: 60px;
            border-radius: 14px;
            margin-right: 12px;
            border: 1px solid #E5E5EA;
            color: var(--text-sub);
            transition: 0.2s;
        }
        .date-pill.active {
            background: #1C1C1E; /* æ·±è‰²é¸ä¸­æ…‹ */
            color: #fff;
            border-color: #1C1C1E;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .date-pill .day-label { font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
        .date-pill .date-num { font-size: 18px; font-weight: 700; }

        /* å¤©æ°£èˆ‡æ¨™é¡Œå€ */
        .header-info { padding: 20px 20px 10px 20px; display: flex; justify-content: space-between; align-items: flex-end; }
        .trip-title { font-size: 28px; font-weight: 800; }
        .weather-badge { background: #fff; padding: 6px 12px; border-radius: 20px; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; }

        /* è¡Œç¨‹å¡ç‰‡ (æ¨¡ä»¿æˆªåœ–) */
        .itinerary-container { padding: 10px 20px; min-height: 50vh; }
        .day-divider { font-size: 18px; font-weight: 700; margin: 20px 0 10px 0; color: var(--text-main); display: none; } /* éš±è—èˆŠç‰ˆæ¨™é¡Œ */

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            position: relative;
            border-left: 6px solid var(--color-other); /* é è¨­é¡è‰² */
            display: flex;
            flex-direction: column;
        }
        /* é¡åˆ¥é¡è‰²å°æ‡‰ */
        .card[data-cat="food"] { border-left-color: var(--color-food); }
        .card[data-cat="spot"] { border-left-color: var(--color-spot); }
        .card[data-cat="shop"] { border-left-color: var(--color-shop); }
        .card[data-cat="move"] { border-left-color: var(--color-move); }

        .time-badge {
            background: #F2F2F7;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
            align-self: flex-start;
            margin-bottom: 8px;
            display: flex; align-items: center; gap: 5px;
        }
        .cat-tag { font-size: 10px; opacity: 0.7; margin-left: 5px; padding-left: 5px; border-left: 1px solid #ccc; }
        
        .card-title { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
        .card-desc { font-size: 14px; color: var(--text-sub); line-height: 1.5; white-space: pre-wrap; }
        .card-actions { margin-top: 12px; display: flex; justify-content: flex-end; gap: 10px; }
        .icon-btn { color: var(--text-sub); font-size: 14px; cursor: pointer; padding: 5px; }
        .naver-link { color: #03C75A; font-weight: 600; font-size: 12px; text-decoration: none; display: flex; align-items: center; margin-right: auto; }

        /* è¨˜å¸³å€å¡Š */
        .expense-header { background: #fff; padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .balance-board { text-align: center; margin-bottom: 15px; }
        .balance-amount { font-size: 32px; font-weight: 800; color: var(--text-main); }
        .balance-label { font-size: 12px; color: var(--text-sub); }
        
        .member-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .member-chip { background: #F2F2F7; padding: 6px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; }

        .expense-item { display: flex; align-items: center; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.03); }
        .exp-icon { width: 40px; height: 40px; background: #F2F2F7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 18px; }
        .exp-info { flex: 1; }
        .exp-title { font-size: 15px; font-weight: 600; }
        .exp-detail { font-size: 12px; color: var(--text-sub); margin-top: 2px; }
        .exp-amount { text-align: right; }
        .amt-main { font-size: 16px; font-weight: 700; }
        .amt-sub { font-size: 11px; color: var(--text-sub); }

        /* çµç®—å ±è¡¨ Modal */
        .report-box { background: #F9F9F9; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 14px; }
        .debt-line { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd; }

        /* åº•éƒ¨å°èˆª (æ¨¡æ“¬ App) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; z-index: 100;
        }
        .nav-item { text-align: center; flex: 1; color: #999; cursor: pointer; }
        .nav-item.active { color: #000; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-label { font-size: 10px; font-weight: 600; }

        /* æµ®å‹•æŒ‰éˆ• (åªåœ¨è¡Œç¨‹é é¡¯ç¤º) */
        .fab { position: fixed; bottom: 90px; right: 20px; background: #1C1C1E; color: #fff; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 101; transition: 0.2s; }
        .fab:active { transform: scale(0.95); }

        /* å½ˆçª—æ¨£å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-sheet { background: #fff; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 24px 24px 0 0; padding: 25px; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .form-group { margin-bottom: 16px; }
        .form-label { font-size: 12px; font-weight: 600; color: #888; margin-bottom: 6px; display: block; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #E5E5EA; border-radius: 12px; font-size: 16px; background: #FAFAFA; }
        .form-control:focus { border-color: #000; background: #fff; outline: none; }
        
        .tag-select { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; }
        .tag-option { padding: 8px 16px; background: #F2F2F7; border-radius: 20px; font-size: 13px; cursor: pointer; border: 1px solid transparent; white-space: nowrap; }
        .tag-option.selected { background: #1C1C1E; color: #fff; }

        .btn-primary { width: 100%; background: #1C1C1E; color: #fff; padding: 15px; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; margin-top: 10px; }
        
        /* æˆå“¡é¸æ“‡ */
        .member-checks { display: flex; flex-wrap: wrap; gap: 10px; }
        .check-box { display: flex; align-items: center; background: #F2F2F7; padding: 8px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .check-box.checked { background: #E4E4E4; border: 1px solid #999; }
        .check-box input { display: none; }
        .check-box i { margin-right: 5px; color: transparent; }
        .check-box.checked i { color: #000; }

    </style>
</head>
<body>

    <!-- é ‚éƒ¨æ—¥æœŸæ¢ (å‹•æ…‹ç”Ÿæˆ) -->
    <div id="date-scroller" class="date-scroller">
        <!-- JS æœƒåœ¨é€™è£¡ç”¢ç”Ÿ Day 1, Day 2... -->
    </div>

    <div class="header-info">
        <div>
            <div class="trip-title">Seoul 2026</div>
            <div style="font-size:13px; color:#888;">ç•¢æ¥­æ—…è¡Œ â€¢ å…±ç­†è¡Œç¨‹</div>
        </div>
        <a href="https://www.accuweather.com/zh/kr/seoul/226081/weather-forecast/226081" target="_blank" class="weather-badge" style="text-decoration:none; color:#333;">
            <i class="fas fa-sun" style="color:#FF9500; margin-right:5px;"></i> å¤©æ°£
        </a>
    </div>

    <!-- é é¢å®¹å™¨ -->
    <div id="page-itinerary" class="page-view" style="display:block;">
        <div id="itinerary-list" class="itinerary-container">
            <!-- è¡Œç¨‹å¡ç‰‡æœƒå‡ºç¾åœ¨é€™ -->
        </div>
    </div>

    <div id="page-expense" class="page-view" style="display:none; padding:20px;">
        <div class="expense-header">
            <div class="balance-board">
                <div class="balance-label">ç¸½æ”¯å‡º (TWD)</div>
                <div class="balance-amount" id="total-expense-twd">0</div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="form-label">æˆå“¡åå–®</div>
                <div style="font-size:12px; color:blue; cursor:pointer;" onclick="openMemberModal()">âš™ï¸ è¨­å®š</div>
            </div>
            <div id="member-list-display" class="member-chips"></div>
            <button onclick="calculateDebts()" style="width:100%; margin-top:15px; padding:10px; background:#fff; border:1px solid #ddd; border-radius:10px; font-weight:600;">ğŸ§® è¨ˆç®—åˆ†å¸³ (èª°è©²çµ¦èª°éŒ¢)</button>
        </div>

        <div id="expense-list"></div>
    </div>

    <!-- æµ®å‹•æŒ‰éˆ• -->
    <div class="fab" onclick="openAddModal()">
        <i class="fas fa-plus"></i>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('itinerary')">
            <div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div>
            <div class="nav-label">è¡Œç¨‹</div>
        </div>
        <div class="nav-item" onclick="switchPage('expense')">
            <div class="nav-icon"><i class="fas fa-wallet"></i></div>
            <div class="nav-label">è¨˜å¸³</div>
        </div>
    </div>

    <!-- [Modal] æ–°å¢è¡Œç¨‹/è¨˜å¸³ -->
    <div id="modal-add" class="modal" onclick="if(event.target === this) closeAddModal()">
        <div class="modal-sheet">
            <h3 style="margin-top:0; margin-bottom:20px;">æ–°å¢é …ç›®</h3>
            
            <div class="tag-select">
                <div class="tag-option selected" id="tab-plan" onclick="toggleAddType('plan')">ğŸ“ è¡Œç¨‹</div>
                <div class="tag-option" id="tab-exp" onclick="toggleAddType('expense')">ğŸ’° è¨˜å¸³</div>
            </div>

            <!-- è¡Œç¨‹è¡¨å–® -->
            <div id="form-plan">
                <div class="form-group">
                    <label class="form-label">æ—¥æœŸèˆ‡æ™‚é–“</label>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="p-date" class="form-control" onchange="updateDateScroller()">
                        <input type="time" id="p-time" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">é¡åˆ¥ (æ±ºå®šå¡ç‰‡é¡è‰²)</label>
                    <div class="tag-select" id="cat-selector">
                        <div class="tag-option selected" data-val="food" onclick="selectCat(this)">ğŸŠ ç”¨é¤</div>
                        <div class="tag-option" data-val="spot" onclick="selectCat(this)">ğŸŒ³ æ™¯é»</div>
                        <div class="tag-option" data-val="shop" onclick="selectCat(this)">ğŸ›ï¸ è³¼ç‰©</div>
                        <div class="tag-option" data-val="move" onclick="selectCat(this)">ğŸš… äº¤é€š</div>
                    </div>
                    <input type="hidden" id="p-cat" value="food">
                </div>
                <div class="form-group">
                    <label class="form-label">åç¨±</label>
                    <input type="text" id="p-title" class="form-control" placeholder="ä¾‹ï¼šå¼˜å¤§çƒ¤è‚‰">
                </div>
                <div class="form-group">
                    <label class="form-label">Naver Map é€£çµ (é¸å¡«)</label>
                    <input type="text" id="p-link" class="form-control" placeholder="è²¼ä¸Šç¶²å€...">
                </div>
                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea id="p-note" class="form-control" rows="3"></textarea>
                </div>
            </div>

            <!-- è¨˜å¸³è¡¨å–® -->
            <div id="form-exp" style="display:none;">
                <div class="form-group">
                    <label class="form-label">æ¶ˆè²»é …ç›®</label>
                    <input type="text" id="e-title" class="form-control" placeholder="ä¾‹ï¼šè¶…å¸‚æ¡è³¼">
                </div>
                <div class="form-group">
                    <label class="form-label">é‡‘é¡ & å¹£åˆ¥</label>
                    <div style="display:flex; gap:10px;">
                        <select id="e-curr" class="form-control" style="width:80px;">
                            <option value="KRW">â‚©</option>
                            <option value="TWD">NT$</option>
                        </select>
                        <input type="number" id="e-amt" class="form-control" placeholder="é‡‘é¡">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">èª°å…ˆä»˜éŒ¢ï¼Ÿ (Payer)</label>
                    <select id="e-payer" class="form-control">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">èª°è¦åˆ†æ“”ï¼Ÿ (Split)</label>
                    <div id="e-split-container" class="member-checks">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ Checkbox -->
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="saveData()">å„²å­˜</button>
        </div>
    </div>

    <!-- [Modal] æˆå“¡è¨­å®š -->
    <div id="modal-member" class="modal" onclick="if(event.target === this) document.getElementById('modal-member').classList.remove('show')">
        <div class="modal-sheet">
            <h3>ğŸ‘¥ æˆå“¡è¨­å®š</h3>
            <p style="font-size:12px; color:#888;">è«‹è¼¸å…¥æˆå“¡åå­—ï¼Œç”¨é€—è™Ÿåˆ†éš” (ä¾‹: å°æ˜, å°è¯)</p>
            <input type="text" id="member-input" class="form-control" placeholder="å°æ˜, å°è¯">
            <button class="btn-primary" onclick="saveMembers()">æ›´æ–°æˆå“¡åå–®</button>
        </div>
    </div>

    <!-- [Modal] çµç®—å ±è¡¨ -->
    <div id="modal-report" class="modal" onclick="if(event.target === this) document.getElementById('modal-report').classList.remove('show')">
        <div class="modal-sheet">
            <h3>ğŸ§¾ çµç®—å ±è¡¨</h3>
            <p style="font-size:12px; color:#888;">å‡è¨­åŒ¯ç‡: 1 KRW = 0.024 TWD (æ‰€æœ‰é‡‘é¡å·²æ›ç®—ç‚ºå°å¹£)</p>
            <div id="report-content" class="report-box"></div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ====================================================
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Firebase Config ğŸ‘‡ğŸ‘‡ğŸ‘‡
        // ====================================================
        const firebaseConfig = {
            // ... æŠŠä½ çš„å…§å®¹è²¼å›ä¾†é€™è£¡ ...
        };
        // ====================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let members = []; // æˆå“¡åå–®
        let plans = [];
        let expenses = [];
        let currentDayFilter = 'all'; // all or '2026-04-26'
        const RATE = 0.024; // éŸ“å¹£åŒ¯ç‡

        // --- åˆå§‹åŒ–ç›£è½ ---
        
        // 1. ç›£è½æˆå“¡
        onValue(ref(db, 'settings/members'), (snap) => {
            const val = snap.val();
            members = val ? val.split(',').map(s => s.trim()).filter(s => s) : [];
            renderMemberUI();
        });

        // 2. ç›£è½è¡Œç¨‹ (è‡ªå‹•æ™‚é–“æ’åº)
        onValue(ref(db, 'plans'), (snap) => {
            const data = snap.val();
            plans = data ? Object.entries(data).map(([k,v]) => ({id:k, ...v})) : [];
            // æ’åº: æ—¥æœŸ -> æ™‚é–“
            plans.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
            renderDateScroller();
            renderPlans();
        });

        // 3. ç›£è½è¨˜å¸³
        onValue(ref(db, 'expenses'), (snap) => {
            const data = snap.val();
            expenses = data ? Object.entries(data).map(([k,v]) => ({id:k, ...v})) : [];
            // æ’åº: æ–°çš„åœ¨ä¸Šé¢
            expenses.sort((a,b) => b.timestamp - a.timestamp);
            renderExpenses();
        });

        // --- æ¸²æŸ“ UI ---

        window.renderDateScroller = () => {
            const container = document.getElementById('date-scroller');
            const uniqueDates = [...new Set(plans.map(p => p.date))].sort();
            
            let html = `<div class="date-pill ${currentDayFilter === 'all' ? 'active' : ''}" onclick="filterDay('all')">
                            <span class="day-label">ALL</span>
                            <span class="date-num">âˆ</span>
                        </div>`;
            
            uniqueDates.forEach((date, index) => {
                const dayNum = date.split('-')[2];
                html += `<div class="date-pill ${currentDayFilter === date ? 'active' : ''}" onclick="filterDay('${date}')">
                            <span class="day-label">DAY ${index + 1}</span>
                            <span class="date-num">${dayNum}</span>
                        </div>`;
            });
            container.innerHTML = html;
        };

        window.renderPlans = () => {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            
            const filtered = currentDayFilter === 'all' ? plans : plans.filter(p => p.date === currentDayFilter);

            filtered.forEach(item => {
                const linkHtml = item.link ? `<a href="${item.link}" target="_blank" class="naver-link"><i class="fas fa-map-marker-alt"></i> è§£é–åœ¨åœ°æƒ…å ± (Map)</a>` : '<span></span>';
                
                // é¡åˆ¥æ¨™ç±¤æ–‡å­—
                let catText = "";
                if(item.cat === 'food') catText = "ç”¨é¤";
                else if(item.cat === 'spot') catText = "æ™¯é»";
                else if(item.cat === 'shop') catText = "è³¼ç‰©";
                else if(item.cat === 'move') catText = "äº¤é€š";

                list.innerHTML += `
                    <div class="card" data-cat="${item.cat || 'other'}">
                        <div class="time-badge">
                            ${item.time} 
                            <span class="cat-tag">${catText}</span>
                        </div>
                        <div class="card-title">${item.title}</div>
                        <div class="card-desc">${item.note}</div>
                        <div class="card-actions">
                            ${linkHtml}
                            <div class="icon-btn" onclick="deleteItem('plans', '${item.id}')"><i class="fas fa-trash"></i></div>
                        </div>
                    </div>
                `;
            });

            if(filtered.length === 0) list.innerHTML = `<div style="text-align:center; padding:40px; color:#ccc;">ç„¡è¡Œç¨‹</div>`;
        };

        window.renderExpenses = () => {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let totalTWD = 0;

            expenses.forEach(item => {
                // è¨ˆç®—é¡¯ç¤ºé‡‘é¡
                let finalTWD = 0;
                let displayAmt = '';
                if(item.currency === 'KRW') {
                    finalTWD = Math.round(item.amount * RATE);
                    displayAmt = `â‚©${item.amount}`;
                } else {
                    finalTWD = parseInt(item.amount);
                    displayAmt = `NT$${item.amount}`;
                }
                totalTWD += finalTWD;

                // ä»˜æ¬¾äººé ­åƒ
                const payerInitial = item.payer ? item.payer[0] : '?';

                list.innerHTML += `
                    <div class="expense-item">
                        <div class="exp-icon">${payerInitial}</div>
                        <div class="exp-info">
                            <div class="exp-title">${item.title}</div>
                            <div class="exp-detail">${item.payer} ä»˜æ¬¾ â€¢ åˆ†çµ¦ ${item.splitMembers ? item.splitMembers.length : 0} äºº</div>
                        </div>
                        <div class="exp-amount">
                            <div class="amt-main">${item.currency === 'TWD' ? 'NT$' : 'â‚©'}${item.amount}</div>
                            <div class="amt-sub">ç´„ NT$${finalTWD}</div>
                        </div>
                        <i class="fas fa-trash" style="margin-left:10px; color:#ddd; cursor:pointer;" onclick="deleteItem('expenses', '${item.id}')"></i>
                    </div>
                `;
            });
            document.getElementById('total-expense-twd').innerText = totalTWD.toLocaleString();
        };

        window.renderMemberUI = () => {
            // 1. è¨˜å¸³é¦–é é¡¯ç¤º
            const display = document.getElementById('member-list-display');
            display.innerHTML = members.map(m => `<div class="member-chip">${m}</div>`).join('');

            // 2. æ–°å¢è¨˜å¸³é¸å–® (Payer)
            const payerSelect = document.getElementById('e-payer');
            payerSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');

            // 3. æ–°å¢è¨˜å¸³åˆ†æ“” (Split)
            const splitContainer = document.getElementById('e-split-container');
            splitContainer.innerHTML = members.map(m => `
                <div class="check-box checked" onclick="this.classList.toggle('checked')">
                    <i class="fas fa-check"></i> ${m}
                    <input type="checkbox" value="${m}" checked>
                </div>
            `).join('');

            // 4. è¨­å®š Modal è£¡çš„å€¼
            document.getElementById('member-input').value = members.join(', ');
        };

        // --- åŠŸèƒ½é‚è¼¯ ---

        window.saveData = () => {
            const isPlan = document.getElementById('tab-plan').classList.contains('selected');
            
            if(isPlan) {
                const data = {
                    date: document.getElementById('p-date').value,
                    time: document.getElementById('p-time').value,
                    cat: document.getElementById('p-cat').value,
                    title: document.getElementById('p-title').value,
                    link: document.getElementById('p-link').value,
                    note: document.getElementById('p-note').value
                };
                if(!data.date || !data.title) return alert('è«‹å¡«å¯«æ—¥æœŸèˆ‡åç¨±');
                push(ref(db, 'plans'), data);
            } else {
                // ç²å–é¸ä¸­çš„åˆ†æ“”äºº
                const splitDivs = document.querySelectorAll('#e-split-container .check-box.checked input');
                const splitMembers = Array.from(splitDivs).map(el => el.value);

                if(splitMembers.length === 0) return alert('è‡³å°‘è¦é¸ä¸€å€‹åˆ†æ“”äºº');

                const data = {
                    title: document.getElementById('e-title').value,
                    currency: document.getElementById('e-curr').value,
                    amount: Number(document.getElementById('e-amt').value),
                    payer: document.getElementById('e-payer').value,
                    splitMembers: splitMembers,
                    timestamp: Date.now()
                };
                if(!data.title || !data.amount) return alert('è«‹å¡«å¯«é …ç›®èˆ‡é‡‘é¡');
                push(ref(db, 'expenses'), data);
            }
            closeAddModal();
        };

        window.calculateDebts = () => {
            if(members.length < 2) return alert('æˆå“¡å¤ªå°‘ï¼Œç„¡æ³•åˆ†å¸³');

            let balance = {}; 
            members.forEach(m => balance[m] = 0); // æ­¸é›¶

            // è¨ˆç®—æ¯å€‹äººè©²ä»˜å¤šå°‘ã€å¯¦éš›ä»˜å¤šå°‘
            expenses.forEach(exp => {
                // çµ±ä¸€æ›ç®—æˆå°å¹£è¨ˆç®—
                let amtTWD = exp.currency === 'KRW' ? Math.round(exp.amount * RATE) : Number(exp.amount);
                
                // ä»˜æ¬¾äººå…ˆ + (ä»–å¤šå‡ºçš„éŒ¢)
                if(balance[exp.payer] !== undefined) {
                    balance[exp.payer] += amtTWD;
                }

                // åˆ†æ“”äºº - (ä»–å€‘è©²çµ¦çš„éŒ¢)
                const share = Math.round(amtTWD / exp.splitMembers.length);
                exp.splitMembers.forEach(m => {
                    if(balance[m] !== undefined) {
                        balance[m] -= share;
                    }
                });
            });

            // ç”¢ç”Ÿå ±è¡¨
            let html = '';
            let debtors = [];
            let creditors = [];

            // åˆ†é¡
            for (const [name, amt] of Object.entries(balance)) {
                if(amt < -10) debtors.push({name, amt}); // æ¬ éŒ¢çš„
                else if(amt > 10) creditors.push({name, amt}); // è¢«æ¬ çš„
            }

            debtors.sort((a,b) => a.amt - b.amt); // æ¬ æœ€å¤šçš„æ’å‰é¢
            creditors.sort((a,b) => b.amt - a.amt); // è¢«æ¬ æœ€å¤šçš„æ’å‰é¢

            // è²ªå©ªæ¼”ç®—æ³•é…å°
            let i = 0; // debtor index
            let j = 0; // creditor index

            while(i < debtors.length && j < creditors.length) {
                let debt = Math.abs(debtors[i].amt);
                let credit = creditors[j].amt;
                let amount = Math.min(debt, credit);

                html += `
                    <div class="debt-line">
                        <span>ğŸ”´ <b>${debtors[i].name}</b> çµ¦ <b>${creditors[j].name}</b></span>
                        <span style="font-weight:bold;">$${amount}</span>
                    </div>`;

                // æ›´æ–°é¤˜é¡
                debtors[i].amt += amount;
                creditors[j].amt -= amount;

                if(Math.abs(debtors[i].amt) < 10) i++;
                if(creditors[j].amt < 10) j++;
            }

            if(html === '') html = '<div style="text-align:center;">ğŸ‰ å¸³ç›®å·²å¹³ï¼æ²’æœ‰äººæ¬ éŒ¢ã€‚</div>';
            
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('modal-report').classList.add('show');
        };

        window.saveMembers = () => {
            const str = document.getElementById('member-input').value;
            set(ref(db, 'settings/members'), str).then(() => {
                document.getElementById('modal-member').classList.remove('show');
            });
        };

        window.deleteItem = (type, id) => {
            if(confirm('ç¢ºå®šåˆªé™¤å—ï¼Ÿ')) {
                remove(ref(db, `${type}/${id}`));
            }
        };

        // --- UI æ§åˆ¶ ---
        window.switchPage = (page) => {
            document.querySelectorAll('.page-view').forEach(el => el.style.display = 'none');
            document.getElementById(`page-${page}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // æµ®å‹•æŒ‰éˆ•åªåœ¨è¡Œç¨‹é å‡ºç¾
            document.querySelector('.fab').style.display = page === 'itinerary' ? 'flex' : 'none';
        };

        window.filterDay = (day) => {
            currentDayFilter = day;
            renderDateScroller();
            renderPlans();
        };

        window.openAddModal = () => {
            document.getElementById('modal-add').classList.add('show');
            document.getElementById('p-date').valueAsDate = new Date();
        };
        window.closeAddModal = () => document.getElementById('modal-add').classList.remove('show');

        window.toggleAddType = (type) => {
            document.querySelectorAll('.tag-option').forEach(el => el.classList.remove('selected'));
            if(type === 'plan') {
                document.getElementById('tab-plan').classList.add('selected');
                document.getElementById('form-plan').style.display = 'block';
                document.getElementById('form-exp').style.display = 'none';
            } else {
                document.getElementById('tab-exp').classList.add('selected');
                document.getElementById('form-plan').style.display = 'none';
                document.getElementById('form-exp').style.display = 'block';
            }
        };

        window.selectCat = (el) => {
            document.querySelectorAll('#cat-selector .tag-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('p-cat').value = el.dataset.val;
        };
        
        window.openMemberModal = () => {
            document.getElementById('modal-member').classList.add('show');
        };

    </script>
</body>
</html>